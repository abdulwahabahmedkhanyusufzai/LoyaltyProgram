<!-- sections/loyalty-dashboard.liquid -->
<div class="loyalty-dashboard" data-customer-id="{{ customer.id }}" data-api-url="https://waro.d.codetors.dev">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <h2>Loyalty Program</h2>
    <p>Hi {{ customer.first_name | default: 'Customer' }}, welcome back.</p>
  </div>

  {% if customer %}
    {% assign discount = customer.discount %}
    {% assign points = customer.metafields.loyalty.points | default: 0 %}
    {% assign tier = customer.metafields.loyalty.tier | default: 'Welcome' %}
    {{ discount }}
    {% comment %}
      Define tiers with min points
    {% endcomment %}
    {% assign tiers_raw = "Bronze:200:bronze.png,Silver:500:silver.png,Gold:750:gold.png,Platinum:1000:gem.png" %}
    {% assign tiers_list = tiers_raw | split: "," %}

    {% comment %}
      --- NEW FIXED PROGRESS LOGIC ---
      Progress ALWAYS uses 0 → 1000 max
    {% endcomment %}
    {% assign max_points = 1000 %}
    {% assign next_tier_name = '' %}
    {% assign points_to_next = 0 %}

    {% for t in tiers_list %}
      {% assign parts = t | split: ":" %}
      {% assign t_name = parts[0] %}
      {% assign t_min = parts[1] | plus: 0 %}
      {% assign t_img = parts[2] %}

      {% if points < t_min and next_tier_name == '' %}
        {% assign next_tier_name = t_name %}
        {% assign points_to_next = t_min | minus: points %}
      {% endif %}
    {% endfor %}

    {% assign progress_percent = points | times: 100 | divided_by: max_points %}
    {% if progress_percent > 100 %}
      {% assign progress_percent = 100 %}
    {% endif %}

    <!-- Loyalty Rating / Points Summary -->
    <div class="loyalty-rating">
      <div class="points-summary">
        <h3>Points Summary</h3>
        <p class="tier-text">
          {% if next_tier_name != '' %}
            You're {{ points_to_next }} points away from {{ next_tier_name }} Tier
          {% else %}
            You've reached the {{ tier }} Tier!
          {% endif %}
        </p>

        <div class="points-info">
          <h1>{{ points }}</h1>
          <p>Total Points</p>
        </div>

        <!-- Tier Progress -->
        <div class="progress-board">
          <div class="tier-progress">
            <div class="tiers">
              {% for t in tiers_list %}
                {% assign parts = t | split: ":" %}
                {% assign t_name = parts[0] %}
                {% assign t_min = parts[1] | plus: 0 %}
                {% assign t_img = parts[2] %}

                <span class="tier {% if points >= t_min %}active{% endif %}"
                      style="left: {{ t_min | times:100 | divided_by:1000 }}%;">
                  <img
                    width="40"
                    height="40"
                    style="height:40px;"
                    src="https://cdn.shopify.com/s/files/1/0921/8428/1416/files/{{ t_img }}?v=1760793539"
                    alt="{{ t_name }}"
                  >
                  {{ t_name }}
                </span>
              {% endfor %}
            </div>

            <div class="tier-bar">
              <div class="tier-fill" style="width: {{ progress_percent }}%;"></div>
            </div>
          </div>

          <!-- Actions -->
          <div class="points-actions">
            <button class="earn-btn">Shop & Earn More</button>
            <button class="redeem-btn" onclick="openRedemptionModal()">Redeem Points</button>
          </div>
        </div>
      </div>

      {% render 'loyalty-sale-product' %}
    </div>

    <!-- Recent Transactions -->
    <div class="loyalty-table">
      <div class="transactions">
        <h3>Recent Transactions</h3>
        <div class="points-actions3">
          <button class="redeem-btn" onclick="openRedemptionModal()">Redeem Points</button>
          <button class="earn-btn">Shop & Earn More</button>
        </div>
      </div>

      <div class="order-history">
        <table class="order-history-table">
          <thead>
            <tr>
              <th>DATE</th>
              <th>ACTION</th>
              <th>DESCRIPTION</th>
              <th>AMOUNT OF</th>
              <th>POINTS (+/-)</th>
            </tr>
          </thead>
          <tbody>
            {% for order in customer.orders limit: 20 %}
              <tr>
                <td>{{ order.created_at | date: '%b %d, %Y' }}</td>
                <td>
                  <span class="badge {{ order.financial_status }}">
                    {% if order.financial_status == 'paid' %}
                      Earned
                    {% else %}
                      Redeemed
                    {% endif %}
                  </span>
                </td>
                <td>
                  <a href="{{ order.customer_url }}">Order {{ order.name }}</a>
                </td>
                <td>{{ order.total_price | money }}</td>
                <td>
                  <span class="{{ order.fulfillment_status }}">{{ order.metafields.loyalty.points }}</span>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="5">You haven't placed any orders yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <!-- Redemption Modal -->
    <div class="redemption-modal" style="display: none;">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Redeem Your Points</h2>
        <p>Select a reward to redeem:</p>
        
        <div class="rewards-list-container">
          <!-- Dynamic Rewards injected by JS -->
          <ul id="tier-rewards-list" class="rewards-list"></ul>
          <p id="no-tier-rewards-msg" style="display:none; text-align:center; color:#666;">
            No specific rewards available for your current tier.
          </p>
        </div>
      </div>
    </div>

  {% endif %}
</div>

<!-- JS / CSS -->
{{ 'loyalty-dashboard.css' | asset_url | stylesheet_tag }}
{{ 'loyalty_program.css' | asset_url | stylesheet_tag }}
{{ 'loyalty-dashboard.css' | asset_url | stylesheet_tag }}
{{ 'loyalty_program.css' | asset_url | stylesheet_tag }}

<script>

  // Global fallback function
  window.openRedemptionModal = function() {
    const modal = document.querySelector(".redemption-modal");
    if (modal) modal.style.display = "flex";
  };

  document.addEventListener("DOMContentLoaded", () => {
    console.log("Loyalty Dashboard JS Loaded (Inline)");

    const customerMetafieldPoints = "{{ points }}";
    const customerMetafieldTier = "{{ tier }}";
    
    // -----------------------------
    // Initial UI Setup (Progress Bar)
    // -----------------------------
    const progressBar = document.querySelector(".tier-bar");
    const fill = progressBar?.querySelector(".tier-fill");
    const pointsEl = document.querySelector(".points-info h1");
    const tierText = document.querySelector(".tier-text");
    const tierProgressContainer = document.querySelector(".tier-progress");
    const badgeUnfulfilled = document.querySelector(".unfulfilled");

    if (progressBar && fill && tierProgressContainer) {
      // Loader
      const loader = document.createElement("div");
      loader.className = "loyalty-loader";
      loader.style.cssText = `
        width: 40px; height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #734A00;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      `;
      progressBar.parentElement.insertBefore(loader, progressBar);
      progressBar.style.display = "none";

      // Tiers Setup
      const tiers = [
        { name: "Bronze", min: 200 },
        { name: "Silver", min: 500 },
        { name: "Gold", min: 750 },
        { name: "Platinum", min: 1000 },
      ];
      const tierElements = Array.from(tierProgressContainer.querySelectorAll(".tier"));
      const maxPoints = tiers[tiers.length - 1].min;

      tierElements.forEach((el, i) => {
        el.style.left = `${(tiers[i].min / maxPoints) * 100}%`;
        el.dataset.tier = tiers[i].name;
      });

      // Helpers
      const animateBar = (percent, instant = false) => {
        fill.style.transition = instant ? "none" : "width 0.5s ease-in-out";
        fill.style.width = `${percent}%`;
      };

      const highlightActiveTier = (tierName) => {
        tierElements.forEach(el => {
          el.classList.toggle("active-tier", el.dataset.tier === tierName);
        });
      };

      const updateUI = (points, currentTierName) => {
        const currentTier = tiers.find(t => t.name === currentTierName) || { name: "Welcome", min: 0 };
        const nextTier = tiers.find(t => t.min > points);
        const progressPercent = nextTier
          ? ((points - currentTier.min) / (nextTier.min - currentTier.min)) * 100
          : 100;
        const tierMessage = nextTier
          ? `You're ${nextTier.min - points} points away from ${nextTier.name} Tier`
          : `You've reached the ${currentTier.name} Tier!`;

        if(pointsEl) pointsEl.textContent = points;
        if(tierText) tierText.textContent = tierMessage;
        if(badgeUnfulfilled) badgeUnfulfilled.textContent = `+${points}`;

        animateBar(progressPercent);
        highlightActiveTier(currentTier.name);
      };

      const hideLoader = () => {
        loader.remove();
        progressBar.style.display = "";
      };

      // Load Data
      const loadLoyaltyData = () => {
        try {
          const points = parseInt(customerMetafieldPoints || "0", 10);
          const tier = customerMetafieldTier || "Welcome";
          updateUI(points, tier);
        } catch (err) {
          console.error("❌ Error updating loyalty UI:", err);
          updateUI(0, "Welcome");
        } finally {
          hideLoader();
        }
      };

      updateUI(0, "Welcome");
      if (typeof customerMetafieldPoints !== "undefined") {
        loadLoyaltyData();
      } else {
        hideLoader();
      }
    }
  });

  // -----------------------------
  // Global Event Delegation
  // -----------------------------
  // -----------------------------
  // Global Event Delegation (Handles dynamic elements)
  // -----------------------------
  
  document.addEventListener("click", async (e) => {
    const dashboard = document.querySelector(".loyalty-dashboard");
    const modal = document.querySelector(".redemption-modal");
    
    // 1. Earn Button
    if (e.target.closest(".earn-btn")) {
      const saleSection = document.querySelector(".loyalty-sale-product") || document.querySelector(".loyal-2");
      if (saleSection) {
        saleSection.scrollIntoView({ behavior: "smooth" });
      } else {
        window.location.href = "/collections/all";
      }
    }

    // 2. Redeem Button (Open Modal & Fetch Dynamic Rewards)
    if (e.target.closest(".redeem-btn")) {
      console.log("Redeem button clicked");
        if (modal) {
        // Collect ALL active tiers
        const activeTierEls = Array.from(document.querySelectorAll(".tier.active, .tier.active-tier"));
        let currentTiers = [];

        if (activeTierEls.length > 0) {
          currentTiers = activeTierEls.map(el => el.dataset.tier).filter(Boolean);
        } else {
             // Fallback: try to guess from text if DOM elements aren't ready/styled
            const tierText = document.querySelector(".tier-text")?.textContent || "";
            if (tierText.includes("Bronze")) currentTiers.push("Bronze");
            if (tierText.includes("Silver")) currentTiers.push("Silver");
            if (tierText.includes("Gold")) currentTiers.push("Gold");
            if (tierText.includes("Platinum")) currentTiers.push("Platinum");
        }
        
        // Ensure unique
        currentTiers = [...new Set(currentTiers)];

        console.log("Detected Tiers for Rewards:", currentTiers);

        const listContainer = document.getElementById("tier-rewards-list");
        const noRewardsMsg = document.getElementById("no-tier-rewards-msg");
        const apiUrl = dashboard?.dataset.apiUrl;
        
        if (listContainer) {
          listContainer.innerHTML = '<p style="text-align:center;">Loading rewards...</p>';
          
          try {
            // Call dynamic API
            const res = await fetch(`${apiUrl}/api/rewards`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tiers: currentTiers }) // Sending Array now
            });

            const data = await res.json();
            console.log("Fetched rewards:", data);

            listContainer.innerHTML = ""; // Clear loader
            const rewards = data.rewards || [];

            if (rewards.length === 0) {
              if(noRewardsMsg) noRewardsMsg.style.display = "block";
              if(noRewardsMsg) noRewardsMsg.textContent = `No rewards found for ${currentTier} tier.`;
            } else {
              if(noRewardsMsg) noRewardsMsg.style.display = "none";
              
              rewards.forEach(r => {
                // Determine label if possible
                let label = r.title;
                if (!label || label.includes(r.code)) {
                     // Try to construct a better label from properties
                     if (r.type === "DiscountCodeFreeShipping") label = "Free Shipping";
                     else if (r.value?.percentage) label = `${r.value.percentage * 100}% Off`;
                     else if (r.value?.amount) label = `€${r.value.amount.amount} Off`;
                }

                const li = document.createElement("div");
                li.className = "reward-item";
                li.style.cssText = "display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:8px; background:#fff;";
                li.innerHTML = `
                  <div class="reward-info">
                    <h4 style="margin:0; font-weight:bold;">${label}</h4>
                    <p style="margin:0; font-size:12px; color:#555;">${r.code}</p>
                    <span style="font-size:10px; background:#f0f0f0; padding:2px 5px; border-radius:4px;">${currentTier} Exclusive</span>
                  </div>
                  <button class="copy-btn" data-code="${r.code}" style="cursor:pointer; padding:5px 12px; background:#2C2A25; color:#fff; border:none; border-radius:20px; font-size:12px;">Copy</button>
                `;
                listContainer.appendChild(li);
              });
            }
          } catch (err) {
            console.error("Failed to fetch rewards", err);
            listContainer.innerHTML = '<p style="color:red; text-align:center;">Failed to load rewards.</p>';
          }
        }

        modal.style.display = "flex";
      }
    }

    // 3. Close Modal
    if (e.target.closest(".close-modal") || e.target === modal) {
      if (modal) modal.style.display = "none";
    }

    // 4. Copy Code Action
    if (e.target.closest(".copy-btn")) {
      const btn = e.target.closest(".copy-btn");
      const code = btn.dataset.code;
      const originalText = btn.textContent;
      
      try {
        await navigator.clipboard.writeText(code);
        btn.textContent = "Copied!";
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      } catch (err) {
        console.error("Failed to copy", err);
        prompt("Copy this code:", code);
      }
    }
  });
</script>
<script type="module" src="{{ 'loyalty_program.js' | asset_url }}"></script>

{% schema %}
{
  "name": "Loyalty Dashboard",
  "target": "section",
  "settings": [
    { "type": "number", "id": "total_points", "label": "Total Points", "default": 55 },
    { "type": "number", "id": "points_to_next_tier", "label": "Points to Next Tier", "default": 5 },
    { "type": "number", "id": "progress_percent", "label": "Progress Percent", "default": 35 }
  ]
}
{% endschema %}
